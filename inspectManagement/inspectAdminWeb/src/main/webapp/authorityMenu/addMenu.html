<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />

    <script src="lib/ligerUI/js/plugins/ligerDialog.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerTextBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerCheckBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerComboBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerGrid.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerDateEditor.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerSpinner.js" type="text/javascript"></script>
    <script type="text/javascript">

        var manager, g,treeManager;
        var strChecked = "";  //得到所选角色id数组
        var setMenuB=document.getElementById("setMenuBtn");
        var submitSetB=document.getElementById("submitSetBtn");
        /*
         * 发送GET请求获得所有角色列表 ,并且在回调函数中将数据源在ligergrid中局部刷新
         */
        $.get($.URL.appauthority.list,null,listCallback,"json");
        function listCallback(data){
            if(data.code==200){
                var gridData = {};
                gridData.Rows = data.data;
                gridData.Total = data.data.length;
                $("#maingrid").ligerGrid({data:gridData})
            }
        }



        /*
         * 定义LigerGrid  ，实现数据的展示和修改
         */
        g = manager = $("#maingrid").ligerGrid({
            enabledEdit: true,clickToEdit:false, isScroll: false,
            data: null,
            width: '50%',
            checkbox:true,
            columns: [
                { display: '主键', name: 'id', width: 50, type: 'int', frozen: true },
                { display: '名称',name: 'name',width:150,
                    editor: { type: 'text'}
                },
                { display: '描述',
                    name: 'description',
                    editor: { type: 'text'}
                }
            ],
            onCheckRow:function(){
                setMenuB.style.visibility="visible";
            }

        });



        //
        function submitMenu()
        {
                var checkedIds="";    //得到所选菜单id数组
                var node = treeManager.getChecked();
                if (node.length!=0)
                {
                    var data={};

                    for(var i=0;i<node.length;i++){
                        var checkedId=node[i].data.id;
                        alert("checkedId" + checkedId);
                        checkedIds+= checkedId + ";";

                    }

                    alert("checkedIds" + checkedIds);
                    alert("strChecked" + strChecked);
                    data.MenuIds= checkedIds;
                    data.authorityIds= strChecked;
                    $.post($.URL.authoritymenu.add,data,addAuthorityMenuCallback,"json");
                }

        }
        function addAuthorityMenuCallback(data){
                if(data.code==200){
                    $.ligerDialog.success("成功分配！");
                }else{
                    $.ligerDialog.success("分配失败！");
                }
        }


        //
        function showMenu()
        {
                strChecked = "";
                var rows = g.getCheckedRows();

                $(rows).each(function ()
                {
                    strChecked += this.id + ",";
                });
                alert('选择的是' + strChecked);
                $.get($.URL.menu.list,null,listCallback,"json");

                var treeData=[];

                function listCallback(data){
                    if(data.code==200){
                        treeData=data.data;
                        $("#tree1").ligerTree({
                            data: treeData,
                            idFieldName:'id',
                            parentIDFieldName:'pid',
                            textFieldName:'name',
                            slide:false,
                            onCheck: function () {
                                submitSetB.style.visibility="visible";
                            }



                        });
                        treeManager=$("#tree1").ligerTree({ checkbox: true, ajaxType: 'get' });


                    }
                    else if(data.code==500){
                        $.ligerDialog.error(data.message);
                    }

                }

        }

         //
        function getCheckedData()
        {
            /*  var rows = g.getCheckedRows();

             $(rows).each(function ()
             {
             strChecked += this.id + ",";
             });*/

        }
    </script>
</head>
<body  style="padding:10px">
<div>
   <input type="button" onclick="getCheckedData()" value="Get Checked Data" />
   <input type="button" id="setMenuBtn" onclick="showMenu()" value="分配菜单" style="visibility: hidden"/>
</div>
<div id="maingrid" style="margin-top:20px"></div>
<div id="treeInfo" style="border:5px solid #bcfcff;float:left; margin-right: 10px;position: relative;left: 600px;top: -150px;width:400px;height:300px">
    <input type="button" id="submitSetBtn" onclick="submitMenu()" value="提交分配" style="visibility: hidden"/>
    <div class="tree" >
        <ul style="width: 244px;" id="tree1"></ul>
    </div>
</div>
</body>
</html>

