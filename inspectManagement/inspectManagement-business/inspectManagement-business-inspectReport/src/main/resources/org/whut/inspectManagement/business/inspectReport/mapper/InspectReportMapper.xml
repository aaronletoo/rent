<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.whut.inspectManagement.business.inspectReport.mapper.InspectReportMapper">
<select id="deviceCountSql" parameterType="map" resultType="map">
     SELECT itr.id,d.name as devname,d.number as numbers,count(itr.id)as itrcount,itr.createtime as intime,t.name as typename
     FROM inspectitemrecord itr,device d,devicetype t
     WHERE itr.deviceId=d.id AND itr.inspectChoiceId=2 AND d.deviceTypeId=t.id AND itr.createtime
     <if test="sTime!=null">
     BETWEEN ${sTime}
     </if>
    <if test="eTime!=null">
     AND ${eTime}
    </if>
     GROUP BY  d.name,itr.createtime
     ORDER BY d.name,itr.createtime
</select>
<select id="deviceInfoSql" parameterType="map" resultType="map">
   SELECT
   tag.id as tagid, tag.name as tagname, u.id, u.name as username, itr.createtime,d.name as devname,d.id as devid,count(itr.id) as itrnum
   FROM inspectitemrecord itr, inspecttag   tag,inspectitem it, device d,user u
   WHERE itr.tag_id = tag.id AND itr.worker_id = u.id AND
   itr.deviceId=d.id  AND itr.inspectChoiceId=2 AND itr.createtime
   <if test="sTime!=null">
   BETWEEN ${sTime}
   </if>
   <if test="eTime!=null">
   AND ${eTime}
   </if>
   <if test="deviceId!=null">
   AND itr.deviceId=#{deviceId}
   </if>
   GROUP BY  tag.name,itr.createtime
   ORDER BY  u.name,d.name,itr.createtime;
</select>
<select id="peopleCountSql" parameterType="map" resultType="map">
 SELECT d.id as did,d.name as devname,u.id as uid,u.name as username,itr.createtime as intime
 FROM inspectitemrecord itr,device d,user u
 WHERE itr.deviceId=d.id  AND u.id=itr.userId
 AND itr.inspectChoiceId=2 AND itr.createtime
 <if test="sTime!=null">
 BETWEEN ${sTime}
 </if>
 <if test="eTime!=null">
 AND ${eTime}
 </if>
 <if test="deviceId!=null">
 AND itr.deviceId=${deviceId}
 </if>
 GROUP BY  itr.createtime
 ORDER BY u.name,d.name,itr.createtime;
</select>
 <select id="peopleInfoSql" parameterType="map" resultType="map">
   SELECT tag.id as tagid, tag.name as tagname, u.id, u.name as username, itr.createtime, d.name as devname,  d.id as devid, count(itr.id) as itrnum
   FROM inspectitemrecord itr, inspecttag   tag,inspectitem it, device d,user u
   WHERE itr.inspectTagId = tag.id AND itr.userId = u.id AND
   itr.deviceId=d.id AND itr.inspectChoiceId=2 AND itr.createtime
   <if test="sTime!=null">
   BETWEEN ${sTime}
   </if>
   <if test="eTime!=null">
   AND ${eTime}
   </if>
   <if test="uId!=null">
   AND itr.userId=${uId}
   </if>
   GROUP BY  tag.name,itr.createtime
   ORDER BY  u.name,d.name,itr.createtime
 </select>
 <select id="deviceHistory" parameterType="map" resultType="map">
  SELECT *,count(id)as itnum
  FROM (select itr.id,d.name as devname,
  <if test="sTime!=null">
  ceiling(datediff(itr.createtime,${sTime})/7)  as zhouqi,
  </if>
  itr.createtime as shijian
  FROM inspectitemrecord itr,device d
  WHERE itr.deviceId=d.id AND  itr.inspectChoiceId=2 AND itr.createtime
  <if test="sTime!=null">
   BETWEEN ${sTime}
  </if>
  <if test="eTime!=null">
  AND ${eTime}
  </if>
  <if test="deviceId!=null">
  AND itr.deviceId=${deviceId}) as s
  </if>
  GROUP BY devname,zhouqi,shijian
 </select>
 <select id="getInspectTableRecordList" parameterType="java.lang.String" resultType="map">
  SELECT
  itr.createtime,sum(itr.exceptioncount) exceptioncount,itr.mongoId,u.id,u.name as username,u.role,t.id,t.name as tablename,d.name as devname,dt.name as typename,em.employeeRoleName
  FROM
  inspecttablerecord itr,user u,inspecttable t,device d,devicetype dt,employee em
  WHERE
  itr.userId=u.id AND itr.inspectTableId=t.id AND itr.deviceId=d.id AND dt.id=d.deviceTypeId AND em.userId=u.id
  <if test='userId!="null"'>
   AND itr.userId=#{userId}
  </if>
  <if test='deviceId!="null"'>
  AND itr.deviceId=#{deviceId}
  </if>
  <if test='sTime!="" and eTime!=""'>
  AND  itr.createtime BETWEEN #{sTime} AND #{eTime}
  </if>
  group by em.employeeRoleName,d.name
 </select>
 <select id="getInfoByMongoDbObject" parameterType="map" resultType="map">
  SELECT
  u.name as userName,d.name as devName,t.name as tName,tag.name as tagName, it.name as itemName,ic.choiceValue as inspectChoiceValue
  FROM
  user u,device d,inspecttable t,inspecttag tag,inspectitem it,inspectchoice ic
  WHERE u.id=#{userId} AND d.id=#{deviceId} AND t.id=#{inspectTableId} AND tag.id=#{inspectTagId} AND it.id=#{inspectItemId} AND ic.choiceValue=#{inspectChoiceValue}
  GROUP BY  u.id,d.id,t.id,tag.id,it.id
 </select>
</mapper>