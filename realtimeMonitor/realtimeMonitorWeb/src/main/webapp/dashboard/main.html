<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="css/main.css"/>
    <script src="lib/json2.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerDialog.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerTextBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerCheckBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerComboBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerGrid.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerDateEditor.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerSpinner.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerButton.js" type="text/javascript"></script>
    <script type="text/javascript" src="js/rightHidePanel.js"></script>
    <script type="text/javascript">
        var tempURL = $.URL.algorithm.meanVarianceValue;
        $(document).ready(function() {
            $.post($.URL.sensor.homePage,null,gridCallback,"json");
        });
        var gridData = {};
//        var gridData_right={};
        function gridCallback(data) {
            if(data.code == 200) {
                gridData.Rows = data.data;
                gridData.Total = data.length;
                f_initGrid();
                f_initRightGrid();
            }
        }
        var grid;
        var h = "";
        var meanVarianceValue = "";

        function f_initGrid() {
            grid = $("#mainGrid").ligerGrid({
                columns:[
                    {display:'序号',name:'id',width:50},
                    {display:'传感器',name:'name',width:70},
                    {display:'监测组',name:'groupName',width:70},
                    {display:'测量区域',name:'areaName',width:70},
                    {display:'采集仪',name:'collectorName',width:70},
                    {display:'编号',name:'number',width:70},
                    {display:'报警参数类型',name:'warnType',width:70},
                    {display:'报警值',name:'warnValue',width:70},
                    {display:'采集仪状态',name:'status',width:70},
                    {display:'当前数值',width:70,render:function(item){
                        var sensorId = item.number;
                        var myURL = tempURL + sensorId;
                        $.ajax({
                            url: myURL,
                            async:false,
                            dataType:'json',
                            success: function meanVarianceCallback(data) {
                                h = "";
                                if(data.code == 200) {
                                    meanVarianceValue = data.data;
                                    h += meanVarianceValue;
                                }
                                else {
                                    h = "0";
                                }
                            }
                        });
                        return returnCurSensor();
                    }},
                    {display:'报警次数',name:'warnCount',width:70
                        ,render:function(item,rowindex) {
                        var count = parseInt(item.warnCount);
                        var curValue = returnCurSensor();
                        var warnSensorValue = item.warnValue;
                        var groupName = item.groupName;
                        var areaName = item.areaName;
                        var name = item.name;
                        var collectorName = item.collectorName;
                        var number = item.number;
                        if(parseInt(curValue) > parseInt(warnSensorValue)) {
                            count++;
                            $.ajax({
                                type:'POST',
                                url: $.URL.sensor.updateWarnCount,
                                data:{count:parseInt(count),groupName:groupName.toString(),
                                areaName:areaName.toString(),name:name.toString(),collectorName:collectorName.toString(),
                                number:number.toString()},
                                async:false,
                                dataType:'json'
                            });
                        }
                        return "<a style='color: #0000FF' href='javascript:jump("+ rowindex +")'>" + count.toString() + "</a>"
                    }
                    }
                ],
                data:gridData,
                 width:'auto',
                usePager:false,
                onSelected:function(rowdata,rowindex) {
                    $("#txtrowindex").val(rowindex);
                }
            });
        }

        function jump(rowid) {
            var row = grid.getRow(rowid);
            var jsonString  = $.toJSON(row);
//            alert(jsonString);
            var sensorJumpName = $.evalJSON(jsonString).name;
//            alert(sensorJumpName);
            $("#choiceContainer").load("dashboard/mainLink.html");
        }
        function returnCurSensor() {

            return h;
        }

        function f_initRightGrid(){
        var grid_right = $("#rightGrid").ligerGrid({
            columns:[
                {name:'collectorName',display:'采集仪',width:70},
                {name:'status',display:'状态',width:50
                    ,render:function(item) {
                    return "<img style='width: 20px' src="+"images/"+item.status+".png></img>";
                }
                }
            ],
            onSelectRow: function (rowdata, rowindex)
            {
                $("#txtrowindex").val(rowindex);
            },
            rownumbers: true,    // 显示序号
            rownumbersColWidth:60,// 显示序号宽度
            frozenRownumbers:true,   // 行序号是否在固定列中
            enabledEdit: false,clickToEdit: false, isScroll: false, usePager: false,
            data:gridData,width:200,resizable:false
        }); }
        var width =$("#choiceContainer").width()-240;
        $("#mainGrid").css("width",width);

    </script>

    <style type="text/css">
        .l-div {height: 30px;margin-top: 10px}
        .l-span-edit-com{margin-left: 10px;  width: 70px;float: left;margin-top:2px}
        .l-edit-com{width: 60px; margin-left: 10px; float: left;}
    </style>
</head>
<body>
<!--<p>测试页面是否正常</p>-->
<div id="choiceContainer">
    <div id="mainGrid"/>
    <div id="rightGrid"/>
</div>
<br/>
</body>
</html>