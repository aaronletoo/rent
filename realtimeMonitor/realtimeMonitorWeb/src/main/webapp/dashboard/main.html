<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="css/main.css"/>
    <script src="lib/json2.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerDialog.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerTextBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerCheckBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerComboBox.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerGrid.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerDateEditor.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerSpinner.js" type="text/javascript"></script>
    <script src="lib/ligerUI/js/plugins/ligerButton.js" type="text/javascript"></script>
    <script type="text/javascript" src="js/rightHidePanel.js"></script>
    <script type="text/javascript">
        var tempURL = $.URL.algorithm.meanVarianceValue;
        $(document).ready(function() {
            $.post($.URL.sensor.homePage,{"fStatus":"true"},gridCallback,"json");
            $.post($.URL.sensor.homePage,{"fStatus":"false"},rightGridCallback,"json");
//            $.post($.URL.warnRecord.list,null,warnRecordCallback,"json");
        });

        var gridData = {};
        var rightGridData = {};
        function gridCallback(data) {
            if(data.code == 200) {
                gridData.Rows = data.data;
                gridData.Total = data.length;
                f_initGrid();
            }
        }

        function rightGridCallback(data) {
            if(data.code == 200) {
                rightGridData.Rows = data.data;
                rightGridData.Total = data.length;
                f_initRightGrid();
            }
        }
        var grid;
        var h = "";
        var meanVarianceValue = "";
        var tempCount = new Array();
        var rowInf;

        function f_initGrid() {
            grid = $("#mainGrid").ligerGrid({
                columns:[
                    {display:'序号',name:'id',width:60},
                    {display:'传感器',name:'name',width:100},
                    {display:'监测组',name:'groupName',width:100},
                    {display:'测量区域',name:'areaName',width:100},
                    {display:'采集仪',name:'collectorName',width:100},
                    {display:'编号',name:'number',width:90},
                    {display:'报警参数类型',name:'warnType',width:100},
                    {display:'报警值',name:'warnValue',width:100},
                    {display:'采集仪状态',name:'status',width:140},
                    {display:'当前数值',name:'curSensorValue',width:90,render:function(item){
                        var sensorId = item.number;
                        var myURL = tempURL + sensorId;
                        $.ajax({
                            url: myURL,
                            async:false,
                            dataType:'json',
                            success: function meanVarianceCallback(data) {
                                h = "";
                                if(data.code == 200) {
                                    meanVarianceValue = data.data;
                                    h += meanVarianceValue;
                                }
                                else {
                                    h = "0";
                                }
                            }
                        });
                        return returnCurSensor();
                    }},
                    {display:'报警次数',name:'warnCount',width:90
                        ,render:function(item,rowindex) {
                        var count = parseInt(item.warnCount);
                        tempCount[rowindex]=count;
                        var curValue = returnCurSensor();
                        var warnSensorValue = item.warnValue;
                        var groupName = item.groupName;
                        var areaName = item.areaName;
                        var name = item.name;
                        var collectorName = item.collectorName;
                        var number = item.number;
                        rowInf = rowindex;
                        if(parseInt(curValue) > parseInt(warnSensorValue)) {
                            count++;
                            tempCount[rowindex]=count;
                            $.ajax({
                                type:'POST',
                                url: $.URL.sensor.updateWarnCount,
                                data:{count:parseInt(count),groupName:groupName.toString(),
                                areaName:areaName.toString(),name:name.toString(),collectorName:collectorName.toString(),
                                number:number.toString()},
                                async:false,
                                dataType:'json'
                            });

                            $.post($.URL.warnCondition.add,{groupName:groupName.toString(),
                            areaName:areaName.toString(),collectorName:collectorName.toString(),sensorName:name.toString(),
                                number:number.toString(),curWarnValue:parseInt(curValue)},"json");
                        }
                        return "<a style='color: #0000FF' href='javascript:jump("+ rowindex +")'>" + count.toString() + "</a>"
                    }
                    }
                ],
                data:gridData,
                 width:width,
                usePager:false,
                onSelected:function(rowdata,rowindex) {
                    $("#txtrowindex").val(rowindex);
                }
            });
        }
        function jump(rowid) {
            var row = grid.getRow(rowid);
            var jsonString  = $.toJSON(row);
            var sensorJumpName = $.evalJSON(jsonString).name;
            var groupJumpName = $.evalJSON(jsonString).groupName;
            var collectorJumpName = $.evalJSON(jsonString).collectorName;
            var areaJumpName = $.evalJSON(jsonString).areaName;
            var jumpNumber = $.evalJSON(jsonString).number;
            var myDate = new Date();
            alert(myDate.toLocaleDateString());
            $.post($.URL.warnCondition.list,{groupName:groupJumpName.toString(),
                areaName:areaJumpName.toString(),collectorName:collectorJumpName.toString(),
                sensorName:sensorJumpName.toString(),number:jumpNumber.toString(),
                sTime:myDate.toLocaleDateString(),eTime:myDate.toLocaleDateString()},warnRecordCallback,"json");
            $("#choiceContainer").load("dashboard/mainLink.html",{},jumpCallback);
        }

        function returnCurSensor() {
            return h;
        }
        var warnRecordData = {};
        var warnRecordGrid;
        function warnRecordCallback(data) {
            if(data.code == 200) {
                warnRecordData.Rows = data.data;
                warnRecordData.Total = data.length;
            }
        }

        function jumpCallback() {
            warnRecordGrid = $("#warnRecordGrid").ligerGrid({
                columns:[
                    {name:'id',display:'序号',width:'auto'},
                    {name:'sensorName',display:'传感器',width:'auto'},
                    {name:'groupName',display:'监测组',width:'auto'},
                    {name:'areaName',display:'测量区域',width:'auto'},
                    {name:'collectorName',display:'采集仪',width:'auto'},
                    {name:'warnTime',display:'报警时间',width:'auto'},
                    {name:'curWarnValue',display:'报警值',width:'auto'}
                ],
                data:warnRecordData,
                width:'auto',
                usePager:true
            });
        }

        var rightGrid;
        function f_initRightGrid(){
            rightGrid = $("#rightGrid").ligerGrid({
            columns:[
                {name:'collectorName',display:'采集仪',width:100},
                {name:'status',display:'状态',width:55
                    ,render:function(item) {
                    if(item.status.toString()=="在线正常工作")   {
                        // return "<img style='width: 20px' src="+"images/"+item.status+".png></img>";
                        return "<img style='width: 20px' src=images/online.png />";
                    }
                    else {
                        return "<img style='width: 20px' src=images/offline.png />";
                    }
                }
                }
            ],
            onSelectRow: function (rowdata, rowindex)
            {
                $("#txtrowindex").val(rowindex);
            },
            rownumbers: true,    // 显示序号
            rownumbersColWidth:60,// 显示序号宽度
            frozenRownumbers:true,   // 行序号是否在固定列中
            enabledEdit: false,clickToEdit: false, isScroll: false, usePager: false,
            data:rightGridData,width:230,resizable:false
        }); }
        var width =$("#choiceContainer").width()-240;
        $("#mainGrid").css("width",width);

        $("#curDataFlush").click(f_click);
        function f_click(){
            var tempRowInf = rowInf;
            for (var i=0;i<=tempRowInf;i++)
            {
//                alert(tempRowInf);
//                alert(tempCount);
                f_updateCurDataCell(i,h);
                f_updateWarnCount(i,tempCount[i]);
            }
        }
        function f_updateCurDataCell(rowInf,updateValue) {
            grid.updateCell('curSensorValue',updateValue,rowInf);
        }

        function f_updateWarnCount(rowInf,updateValue) {
            grid.updateCell('warnCount',updateValue,rowInf);
        }
        setInterval('$("#curDataFlush").trigger("click")',10000);

    </script>

    <style type="text/css">
        .l-div {height: 30px;margin-top: 10px}
        .l-span-edit-com{margin-left: 10px;  width: 70px;float: left;margin-top:2px}
        .l-edit-com{width: 60px; margin-left: 10px; float: left;}
    </style>
</head>
<body>
<!--<p>测试页面是否正常</p>-->
<div id="choiceContainer">
    <div id="mainGrid"/>
    <div id="rightGrid"/>
</div>
<br/>
<div>
    <input id="curDataFlush" type="button" onclick="f_click" value="刷新当前值" style="display: none"/>
</div>
</body>
</html>