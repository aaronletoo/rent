<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title></title>
<link href="lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="css/main.css"/>
<script src="lib/json2.js" type="text/javascript"></script>
<script src="lib/ligerUI/js/plugins/ligerDialog.js" type="text/javascript"></script>
<script src="lib/ligerUI/js/plugins/ligerTextBox.js" type="text/javascript"></script>
<script src="lib/ligerUI/js/plugins/ligerCheckBox.js" type="text/javascript"></script>
<script src="lib/ligerUI/js/plugins/ligerComboBox.js" type="text/javascript"></script>
<script src="lib/ligerUI/js/plugins/ligerGrid.js" type="text/javascript"></script>
<script src="lib/ligerUI/js/plugins/ligerDateEditor.js" type="text/javascript"></script>
<script src="lib/ligerUI/js/plugins/ligerSpinner.js" type="text/javascript"></script>
<script src="lib/ligerUI/js/plugins/ligerButton.js" type="text/javascript"></script>
<script src="lib/ligerUI/js/plugins/ligerTree.js" type="text/javascript"></script>
<script type="text/javascript" src="js/rightHidePanel.js"></script>
    <script type="text/javascript" src="js/highcharts1.js"></script>
    <script type="text/javascript" src="js/highcharts-more.js"></script>
    <script type="text/javascript" src="js/chartTool.js"></script>
    <script type="text/javascript" src="js/chartTool2.js"></script>
    <script type="text/javascript" src="js/chartTool3.js"></script>
    <script type="text/javascript" src="js/chartTool4.js"></script>
 <script type="text/javascript">
$.post($.URL.group.list,null,groupMenuCallback,"json");
var num;
var tempURL = $.URL.sensors.getSensorDataArray;
var myURL;
var leftMenuData=[];
var treeManager=null;
var data1=[];
var dt=1;
var ws;
var wsData;
var sNumList= new Array();
var initSNum = 0;
$(document).ready(function() {
    $("#treeMenu").ligerLayout({leftWidth: 350});
    connect();
});
$("#tab").ligerTab({onBeforeSelectTabItem:function disconnect() {        //失去焦点
    if (ws != null) {
        ws.close();
        ws = null;
    }
}});

function connect() {
    var url= $.URL.websocket.register;
    var s="all"+"|"+2;
    ws =  new WebSocket(url);
    ws.onopen = function () {
        console.log('Info: connection opened.');
        ws.send(s);
        ws.onclose = function (event) {
            console.log('Info: connection closed.');
            console.log(event);			};
    } ;
    ws.onmessage = function (event) {
        console.log ("收到消息！"+event.data);
        var jsonData = eval("(" +event.data+ ")");
        wsData=jsonData.sensors[0].data;
    };
}
function groupMenuCallback(data){
    if(data.code==200){
        leftMenuData=[];
        for(var i=0;i<data.data.length;i++){
            var g={};
            g['pid']=0;
            g['id']=data.data[i].name;
            g['text']=data.data[i].name;
            leftMenuData.push({ id: g.id, pid: g.pid, text: g.text });
        }
        $.post($.URL.area.list,null,areaMenuCallback,"json");
    }
}
function areaMenuCallback(data){
    if(data.code==200){
        var g={};
        g['pid']=data.data[0].groupName;
        g['id']=data.data[0].groupName+data.data[0].name;
        g['text']=data.data[0].name;
        leftMenuData.push({ id: g.id, pid: g.pid, text: g.text ,isExpand:true});
        for(var i=1;i<data.data.length;i++){
            var g={};
            g['pid']=data.data[i].groupName;
            g['id']=data.data[i].groupName+data.data[i].name;
            g['text']=data.data[i].name;
            leftMenuData.push({ id: g.id, pid: g.pid, text: g.text});

        }
        $.post($.URL.sensor.list,null,sensorMenuCallback,"json");
    }
}
function sensorMenuCallback(data){
    if(data.code==200){
        for(var i=0;i<data.data.length;i++){
            var g={};
            g['pid']=data.data[i].groupName+data.data[i].areaName;
            g['id']=data.data[i].id;
            g['text']=data.data[i].name+' 编号：'+data.data[i].number;
            //于此设置图标表示offline。以不同的childIcon参数实现。
            leftMenuData.push({ id: g.id, pid: g.pid, text: g.text });
        }
    }
    leftMenuData[0].isExpand=true;
    $("#tree1").ligerTree({
        data:leftMenuData,
        idFieldName :'id',
        slide : false,
        parentIDFieldName :'pid',
        checkbox: false,
        parentIcon: null,
        nodeWidth:300,
        childIcon: null,
        isExpand:false,
        onclick:onClickLeaf
    });
    treeManager = $("#tree1").ligerGetTreeManager();
//    treeManager.collapseAll();
    if(treeManager.hasChildren(leftMenuData[0])) {
        if(treeManager.hasChildren(leftMenuData[0].children[0])) {
            initSNum = leftMenuData[0].children[0].children[0].id;
                init(initSNum);
        }
        else {
            console.log("没有传感器");
        }
    }
    else {
        console.log("没有检测组");
    }
}

function init(a) {
    if(a) {
        var sensorId = parseInt(a);
        $.ajax({
            url:$.URL.sensor.getNumberBySensorId,
            async:false,
            type:'POST',
            dataType:'json',
            data:{"sensorId":sensorId},
            success:function sensorNumberCallback(data){
                num = data.data[0].number;
            }
        });
        $.post($.URL.sensor.getDataTypeByIdAndAppId,{"id":sensorId},dataTypeCallback,"json");
        ws.onmessage = function (event) {
            console.log ("收到消息！"+event.data);
            var jsonData = eval("(" +event.data+ ")");
            wsData=jsonData.sensors[0].data;
            console.log(wsData);
            var sensorNum=jsonData.sensors[0].sensorNum;
            if(num==sensorNum){
                if(dt==1)drawChart("#waveCanvas", wsData, "mV");
                else if(dt==2) drawChart2("#waveCanvas", wsData, "mV");
                else if(dt==3) drawChart3("#waveCanvas", wsData, "mV");
                else if(dt==4) drawChart4("#waveCanvas", wsData, "mV");
            }
        };
    }
}

function onClickLeaf(node){
    if(!isNaN(node.data.id)){
        var sensorId = parseInt(node.data.id);
        $.ajax({
            url:$.URL.sensor.getNumberBySensorId,
            async:false,
            type:'POST',
            dataType:'json',
            data:{"sensorId":sensorId},
            success:function sensorNumberCallback(data){
                num = data.data[0].number;
            }
        });
        $.post($.URL.sensor.getDataTypeByIdAndAppId,{"id":sensorId},dataTypeCallback,"json");
        ws.onmessage = function (event) {
            console.log ("收到消息！"+event.data);
            var jsonData = eval("(" +event.data+ ")");
            wsData=jsonData.sensors[0].data;
            console.log(wsData);
            var sensorNum=jsonData.sensors[0].sensorNum;
            if(num==sensorNum){
                if(dt==1)drawChart("#waveCanvas", wsData, "mV");
                else if(dt==2) drawChart2("#waveCanvas", wsData, "mV");
                else if(dt==3) drawChart3("#waveCanvas", wsData, "mV");
                else if(dt==4) drawChart4("#waveCanvas", wsData, "mV");
            }
        };
    }
}
function dataTypeCallback(data) {
        if(data.code == 200) {
            dt=data.data;
        }
        else {
            alert("出错！");
        }
    }
</script>

<style type="text/css">
    .l-div {height: 30px;margin-top: 10px}
    .l-span-edit-com{margin-left: 10px;  width: 70px;float: left;margin-top:2px}
    .l-edit-com{width: 60px; margin-left: 10px; float: left;}
</style>
</head>
<body>
<!--<p>测试页面是否正常</p>-->
<div id="treeMenu" style="width: 100%;height: 100%;">
    <div position="left"><ul class="l-tree" id="tree1"></ul></div>
    <div position="center" id="mainGrid">
        <div position="center" id="waveCanvas" style="min-width:700px;height:400px">
        </div>
    </div>
    <!--div position="right" id="rightGrid"></div-->
</div>
</body>
</html>